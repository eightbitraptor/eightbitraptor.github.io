<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.104.3" />


<title>Weird Ruby: Using `SUPPORT_JOKE` to actually help! - eightbitraptor</title>
<meta property="og:title" content="Weird Ruby: Using `SUPPORT_JOKE` to actually help!">
<meta property="twitter:title" content="Weird Ruby: Using `SUPPORT_JOKE` to actually help!">

<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-05-22">
<meta property="article:author" content="https://www.eightbitraptor.com/about/">

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@eightbitraptor">
<meta name="twitter:creator" content="@eightbitraptor">
<meta name="twitter:image" content="https://www.eightbitraptor.com/images/avatar.png">




  <link href='https://www.eightbitraptor.com/favicon.ico' rel='icon' type='image/x-icon'/>



  




<link rel="icon" href="https://www.eightbitraptor.com/images/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" href="https://www.eightbitraptor.com/css/main.css" media="all">
<link rel="stylesheet" href="https://www.eightbitraptor.com/css/lastfm.css" media="all">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700">
<script src="https://www.eightbitraptor.com/js/lastfm.js"></script>

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://www.eightbitraptor.com/" class="nav-logo">
    <img src="https://www.eightbitraptor.com/images/avatar.jpeg"
         width="100"
         height="100"
         alt="eightbitraptor.com">
  </a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="https://www.github.com/eightbitraptor">GitHub</a></li>
    
    <li><a href="https://wiki.eightbitraptor.com">Wiki</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">5 min read</span>
    

    <h1 class="article-title">Weird Ruby: Using `SUPPORT_JOKE` to actually help!</h1>

    
    <span class="article-date">May 24, 2022</span>
    

    <div class="article-content">
      <p>So, Ruby, for whatever reason, has a bunch of easter eggs hidden in its VM.
There is the <a href="https://patshaughnessy.net/2012/2/29/the-joke-is-on-us-how-ruby-1-9-supports-the-goto-statement"><code> __goto__</code> and <code>__label__</code>
syntax</a>;
for when you really really need a goto statement in your program! And there are
also a couple of specific VM instructions that you can optionally enable.</p>
<p>To enable all this you need to hardcode the <code>OPT_SUPPORT_JOKE</code>
preprocessor constant in <code>vm_opts.h</code> to <code>1</code> (it defaults to <code>0</code> obviously).</p>
<p>As an aside: this variable <em>is</em> all wired up via the autotools, but setting it
the normal way using <code>cppflags=&quot;-DOPT_SUPPORT_JOKE=1&quot;</code> doesn&rsquo;t work, because the
Ruby script that parses the VMs instruction definition DSL into actual C
code relies on grepping the content of <code>vm_opts.h</code> for its optional values, but
when you use <code>cflags</code>, they&rsquo;re effectively configured in the memory of a
different process.</p>
<p>So if you rely on the <code>cflags</code> only, you get a bunch of code inside <code>#ifdef</code>&rsquo;s
that is compiled assuming certain instructions exist, but those instructions
don&rsquo;t exist because their existence depends on an actual <code>1</code> being hard coded
inside the file.</p>
<p>Ask me how I know.</p>
<p>Anyway&hellip; Ranting aside</p>
<p>I went down this rabbit hole for a reason. I was looking at the output of
running ruby with the various <code>--dump</code> options to work out which ast nodes
generated which YARV instructions.</p>
<p>For instance, the Ruby code <code>while true; end</code> generates this AST</p>
<pre tabindex="0"><code>❯ ruby --dump=parsetree_with_comment -e &#39;while true; end&#39;

# @ NODE_SCOPE (id: 3, line: 1, location: (1,0)-(1,15))
# | # new scope
# | # format: [nd_tbl]: local table, [nd_args]: arguments, [nd_body]: body
# +- nd_tbl (local table): (empty)
# +- nd_args (arguments):
# |   (null node)
# +- nd_body (body):
#     @ NODE_WHILE (id: 2, line: 1, location: (1,0)-(1,15))*
#     | # while statement
#     | # format: while [nd_cond]; [nd_body]; end
#     | # example: while x == 1; foo; end
#     +- nd_state (begin-end-while?): 1 (while-end)
#     +- nd_cond (condition):
#     |   @ NODE_TRUE (id: 0, line: 1, location: (1,6)-(1,10))
#     |   | # true
#     |   | # format: true
#     |   | # example: true
#     +- nd_body (body):
#         @ NODE_BEGIN (id: 1, line: 1, location: (1,11)-(1,11))
#         | # begin statement
#         | # format: begin; [nd_body]; end
#         | # example: begin; 1; end
#         +- nd_body (body):
#             (null node)
</code></pre><p>which then compiles into this YARV bytecode, which the VM then runs:</p>
<pre tabindex="0"><code>❯ ruby --dump=insns_without_opt -e &#39;while true; end&#39;
== disasm: #&lt;ISeq:&lt;main&gt;@-e:1 (1,0)-(1,15)&gt; (catch: FALSE)
0000 jump                                   6                         (   1)[Li]
0002 putnil
0003 pop
0004 jump                                   6
0006 jump                                   6
0008 putnil
0009 leave
</code></pre><p>And what I wanted was basically <code>puts</code> debugging, but for bytecode. I want to
know exactly which lines of bytecode are emitted from each AST node.</p>
<p>My usual trick for this, in normal code land, would be to <code>puts</code> some known text
out to <code>stderr</code> or whatever, at the beginning, and at the end of the code region
I care about, so I can isolate in the output, exactly which log messages I care
about.</p>
<p>So I wondered if I could make a couple of no-op YARV instructions that I could
just insert into my bytecode at various points to let me know where certain
things are being triggered from.</p>
<p>And as we mentioned earlier, It turns out that YARV has a couple of extraneous,
random instructions that maybe we can used to help debug stuff. They&rsquo;re not quite
no-ops, as they do push values back onto the stack (And I guess they were
probably funny once. Maybe[1]).</p>
<pre tabindex="0"><code>/* BLT */
DEFINE_INSN_IF(SUPPORT_JOKE)
bitblt
()
()
(VALUE ret)
{
    ret = rb_str_new2(&#34;a bit of bacon, lettuce and tomato&#34;);
}

/* The Answer to Life, the Universe, and Everything */
DEFINE_INSN_IF(SUPPORT_JOKE)
answer
()
()
(VALUE ret)
{
    ret = INT2FIX(42);
}
</code></pre><p>Neither of these take any operands (illustrated by the first set of empty
parenthesis); nor do they pop values from the stack (the second empty
parens); but they do push a value onto the stack (the value <code>ret</code> in the third set of parens).</p>
<p>This means that, providing you&rsquo;re only debugging simple bytecode (my <code>while true; end</code> is a good example), then you can use these as is. But as soon as you
are relying on the contents of the stack you&rsquo;re going to need to do something a
bit more nuanced (even if that is just following up with a <code>pop</code> instruction to
get rid of the crap you just pushed onto the stack).</p>
<p>Add them to your bytecode at various points in <code>compile.c</code> using the macro
<code>ADD_INSN</code> like this:</p>
<pre tabindex="0"><code>ADD_INSN(ret, line_node, bitlt);
</code></pre><p>And wonder in the beauty of your work</p>
<pre tabindex="0"><code>❯ ./miniruby --dump=insns_without_opt -e &#39;while true; end&#39;
== disasm: #&lt;ISeq:&lt;main&gt;@-e:1 (1,0)-(1,15)&gt; (catch: FALSE)
0000 bitblt                                                           (   1)[Li]
0001 jump                                   7
0003 putnil
0004 pop
0005 jump                                   7
0007 jump                                   7
0009 putnil
0010 bitblt
0011 leave
</code></pre><p>[1]: Look. I enjoy the Hitchhikers guide, and Douglas Adams, as much as the next
sci-fi loving, geriatric-millenial, british computer nerd. But can we just
accept that the number 42 is just a number. And that these jokes have been
<a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-forty_two">done to
death</a>
at this point. Please.</p>

    </div>
  </article>

  

</main>

      <footer class="footer">
        <ul class="footer-links">
          
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with Hugo</a>
          </li>
        </ul>
      </footer>

    </div>

    
  </body>
</html>

